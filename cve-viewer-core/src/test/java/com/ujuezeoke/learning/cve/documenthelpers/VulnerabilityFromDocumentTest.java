package com.ujuezeoke.learning.cve.documenthelpers;

import com.ujuezeoke.learning.cve.model.CveVulnerability;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.DocumentHelper;
import org.junit.Before;
import org.junit.Ignore;
import org.junit.Test;

import java.util.List;
import java.util.stream.Collectors;

import static org.hamcrest.core.Is.is;
import static org.junit.Assert.*;

/**
 * Created by ujuezeoke on 01/12/2015.
 */
public class VulnerabilityFromDocumentTest {
    private static final String CVE_DOC = "<cvrfdoc xmlns:cvrf=\"http://www.icasi.org/CVRF/schema/cvrf/1.1\" xmlns=\"http://www.icasi.org/CVRF/schema/cvrf/1.1\"\n" +
            "         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n" +
            "         xsi:schemaLocation=\"http://www.icasi.org/CVRF/schema/cvrf/1.1 http://www.icasi.org/CVRF/schema/cvrf/1.1/cvrf.xsd\n" +
            "http://www.icasi.org/CVRF/schema/cvrf/1.1 \">\n" +
            "    <DocumentTitle xml:lang=\"en\">CVE Output in CVRF 1.1: 20151127</DocumentTitle>\n" +
            "    <DocumentType>CVE List</DocumentType>\n" +
            "    <DocumentPublisher Type=\"Other\">\n" +
            "        <ContactDetails>cve@mitre.org</ContactDetails>\n" +
            "        <IssuingAuthority>The MITRE Corporation</IssuingAuthority>\n" +
            "    </DocumentPublisher>\n" +
            "    <DocumentTracking>\n" +
            "        <Identification>\n" +
            "            <ID>20151127-060146</ID>\n" +
            "        </Identification>\n" +
            "        <Status>Interim</Status>\n" +
            "        <Version>2015.11.27.6</Version>\n" +
            "        <RevisionHistory>\n" +
            "            <Revision>\n" +
            "                <Number>1</Number>\n" +
            "                <Date>2015-11-27T06:01:46</Date>\n" +
            "                <Description>initial public release</Description>\n" +
            "            </Revision>\n" +
            "        </RevisionHistory>\n" +
            "        <InitialReleaseDate>2015-11-27T06:01:46</InitialReleaseDate>\n" +
            "        <CurrentReleaseDate>2015-11-27T06:01:46</CurrentReleaseDate>\n" +
            "        <Generator>\n" +
            "            <Engine>MITRE Custom CVE-to-CVRF Converter 1.3</Engine>\n" +
            "        </Generator>\n" +
            "    </DocumentTracking>\n" +
            "    <DocumentNotes>\n" +
            "        <Note Type=\"General\" Ordinal=\"1\" Title=\"CVE List\" Audience=\"All\">\n" +
            "            This is a list of CVE Identifiers as published by MITRE.\n" +
            "        </Note>\n" +
            "        <Note Type=\"General\" Ordinal=\"2\" Title=\"License\" Audience=\"All\">\n" +
            "            The MITRE Corporation (MITRE) hereby grants you a non-exclusive, royalty-free license to use Common Vulnerabilities and Exposures (CVE (R)) for research, development, and commercial purposes. Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.\n" +
            "        </Note>\n" +
            "        <Note Type=\"General\" Ordinal=\"3\" Title=\"Disclaimers\" Audience=\"All\">\n" +
            "            ALL DOCUMENTS AND THE INFORMATION CONTAINED THEREIN ARE PROVIDED ON AN \"AS IS\" BASIS AND THE CONTRIBUTOR, THE ORGANIZATION HE/SHE REPRESENTS OR IS SPONSORED BY (IF ANY), THE MITRE CORPORATION, ITS BOARD OF TRUSTEES, OFFICERS, AGENTS, AND EMPLOYEES, DISCLAIM ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION THEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.\n" +
            "        </Note>\n" +
            "    </DocumentNotes>\n" +
            "    <Vulnerability xmlns=\"http://www.icasi.org/CVRF/schema/vuln/1.1\" Ordinal=\"77020\">\n" +
            "        <Title>CVE-2015-0001</Title>\n" +
            "        <Notes>\n" +
            "            <Note Type=\"Description\" Ordinal=\"1\">\n" +
            "                The Windows Error Reporting (WER) component in Microsoft Windows 8, Windows 8.1, Windows Server 2012 Gold and R2, and Windows RT Gold and 8.1 allows local users to bypass the Protected Process Light protection mechanism and read the contents of arbitrary process-memory locations by leveraging administrative privileges, aka \"Windows Error Reporting Security Feature Bypass Vulnerability.\"\n" +
            "            </Note>\n" +
            "            <Note Type=\"Other\" Ordinal=\"2\" Title=\"Published\">2015-01-13</Note>\n" +
            "            <Note Type=\"Other\" Ordinal=\"3\" Title=\"Modified\">2015-01-13</Note>\n" +
            "        </Notes>\n" +
            "        <CVE>CVE-2015-0001</CVE>\n" +
            "        <References>\n" +
            "            <Reference>\n" +
            "                <URL>\n" +
            "                    http://technet.microsoft.com/security/bulletin/MS15-006\n" +
            "                </URL>\n" +
            "                <Description>MS:MS15-006</Description>\n" +
            "            </Reference>\n" +
            "        </References>\n" +
            "    </Vulnerability>\n" +
            "</cvrfdoc>";

    private VulnerabilityFromDocument underTest;

    @Before
    public void setUp() throws Exception {
        underTest = new VulnerabilityFromDocument();
    }

    @Test
    public void documentWithOneVulnerability() throws DocumentException {
        Document document = DocumentHelper.parseText(CVE_DOC);
        List<CveVulnerability> cveVulnerabilities = underTest.convert(document);

        assertThat(cveVulnerabilities.size(), is(1));
    }

}